<?php
session_start();
require_once 'config.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $email = trim(filter_var($_POST['email'], FILTER_VALIDATE_EMAIL)); 

    if (!empty($email)) {
        $conn = mysqli_connect(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);

        if (!$conn) {
            die("Database connection failed: " . mysqli_connect_error()); 
        }

        // Check if the email exists 
        $sql = "SELECT * FROM users WHERE email = ?";
        $stmt = mysqli_prepare($conn, $sql);
        mysqli_stmt_bind_param($stmt, "s", $email);
        mysqli_stmt_execute($stmt);
        $result = mysqli_stmt_get_result($stmt);

        if ($row = mysqli_fetch_assoc($result)) {
            
            // Generate a unique reset token
            $resetToken = bin2hex(random_bytes(32)); 

            // Store the token in the database (you'll likely want to add a 'reset_token' column to your 'users' table)
            $sqlUpdate = "UPDATE users SET reset_token = ? WHERE email = ?";
            $stmtUpdate = mysqli_prepare($conn, $sqlUpdate);
            mysqli_stmt_bind_param($stmtUpdate, "ss", $resetToken, $email);
            mysqli_stmt_execute($stmtUpdate);

            // Send a password reset email with a link like: reset_password.php?token=$resetToken
            $resetLink = "http://yourwebsite.com/reset_password.php?token=" . $resetToken;
            $subject = "Password Reset Request";
            $message = "Click the following link to reset your password: " . $resetLink;
            mail($email, $subject, $message); 

            $successMessage = "A password reset link has been sent to your email.";
        } else {
            $errorMessage = "No account found with that email address."; 
        }

        mysqli_close($conn);
    } else {
        $errorMessage = "Please enter your email address.";
    }
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Forgot Password</title>
</head>
<body>
    <h1>Forgot Password</h1>
    <?php if (isset($successMessage)): ?>
        <div style="color: green;"><?php echo $successMessage; ?></div>
    <?php endif; ?>

    <?php if (isset($errorMessage)): ?>
        <div style="color: red;"><?php echo $errorMessage; ?></div>
    <?php endif; ?>

    <form method="POST" action="forgot_password.php">
        <label for="email">Email:</label><br>
        <input type="email" id="email" name="email" required><br><br>
        <input type="submit" value="Send Reset Link">
    </form>
</body>
</html>
